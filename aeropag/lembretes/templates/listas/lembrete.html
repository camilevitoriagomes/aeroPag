{% extends 'modelo.html' %}

{% load static %}

{% block titulo %}
{% endblock %}

{% block conteudo %}
<!-- Importação do CSS do Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
    h3 {
        text-align-last: center;
    }
    body {
        background-color: #e9eaeb; /* Cor de fundo suave */
    }
    .container {
        margin-top: 30px; /* Margem superior para espaçamento */
        padding: 20px; /* Padding para a área do container */
        border-radius: 8px; /* Bordas arredondadas */
        background-color: white; /* Cor de fundo branca para o container */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Sombra suave */
    }
    h3 {
        color: #343a40; /* Cor do título */
        margin-bottom: 20px; /* Espaçamento abaixo do título */
    }
    /* Estilo para o botão minimalista */
    .btn-minimalista {
        background: transparent; /* Fundo transparente */
        border: none; /* Sem borda */
        padding: 0; /* Sem padding */
        color: #343a40; /* Cor do ícone */
        font-size: 1.2rem; /* Aumenta o tamanho do ícone */
    }
    .btn-minimalista:hover {
        color: #007bff; /* Cor ao passar o mouse */
        text-decoration: none; /* Remove underline ao passar o mouse */
    }
    /* Ajuste para garantir que o filtro dropdown não fique cortado */
    .btn-group {
        width: 100%; /* Faz o botão de filtro ocupar toda a largura disponível */
        display: block; /* Faz o grupo de botões ocupar a largura inteira */
    }
    

</style>

<div class="container">
    <h3>Lista de Lembretes Registrados</h3>
    
    <!-- Campo de Pesquisa e Filtro -->
    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" class="form-control" id="search-lembrete" placeholder="Pesquisar por título ou observação...">
        </div>
        <div class="col-md-4">
            <input type="date" class="form-control" id="filter-date" placeholder="Filtrar por data">
        </div>
        <div class="col-md-2">
            <button class="btn btn-secondary w-100" id="clear-filters">Limpar Filtros</button>
        </div>
    </div>

    <!-- Tabela de Lembretes -->
    <div class="table-responsive">
        <table class="table" id="lembrete-table">
            <thead>
                <tr>
                    <th scope="col">Título</th>
                    <th scope="col">OBS</th>
                    <th scope="col">Data</th>
                    <th scope="col">Relevância</th>
                    <th scope="col">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for lembrete in object_list %}
                <tr>
                    <td class="titulo">{{ lembrete.titulo }}</td>
                    <td class="obs">{{ lembrete.obs }}</td>
                    <td class="data">{{ lembrete.data|date:"Y-m-d" }}</td>
                    <td>{{ lembrete.relevancia }}</td>
                    <td>
                        <!-- Botão de Editar -->
                        <button class="btn btn-warning btn-sm" title="Editar" data-lembrete-id="{{ lembrete.pk }}" data-lembrete-titulo="{{ lembrete.titulo }}" data-lembrete-obs="{{ lembrete.obs }}" id="editar-lembrete-{{ lembrete.pk }}">Editar</button>
                        <!-- Botão de Excluir -->
                        <button class="btn btn-danger btn-sm" title="Excluir" data-lembrete-id="{{ lembrete.pk }}" id="excluir-lembrete-{{ lembrete.pk }}">Excluir</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">Nenhum lembrete registrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="text-end mt-3">
        <a href="{% url 'cadastrar-lembrete' %}" class="btn btn-primary">Cadastrar Novo Lembrete</a>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="modalExcluir" tabindex="-1" aria-labelledby="modalExcluirLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalExcluirLabel">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Você tem certeza de que deseja excluir este lembrete?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmar-exclusao">Excluir</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edição -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarLabel">Editar Lembrete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-editar-lembrete" method="POST">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="titulo" class="form-label">Título</label>
                        <input type="text" class="form-control" id="titulo" name="titulo" required>
                    </div>
                    <div class="mb-3">
                        <label for="obs" class="form-label">Observações</label>
                        <textarea class="form-control" id="obs" name="obs" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="data" class="form-label">Data</label>
                        <input type="date" class="form-control" id="data" name="data" required>
                    </div>
                    <input type="hidden" id="lembrete-id" name="lembrete_id">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </form>
                
            </div>
        </div>
    </div>
</div>

<!-- Importação do JavaScript do Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
     document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('search-lembrete');
        const filterDate = document.getElementById('filter-date');
        const clearFilters = document.getElementById('clear-filters');
        const table = document.getElementById('lembrete-table');
        const rows = table.querySelectorAll('tbody tr');

        function filterTable() {
            const searchText = searchInput.value.toLowerCase();
            const selectedDate = filterDate.value;

            rows.forEach(row => {
                const title = row.querySelector('.titulo').textContent.toLowerCase();
                const obs = row.querySelector('.obs').textContent.toLowerCase();
                const date = row.querySelector('.data').textContent;

                const matchesSearch = title.includes(searchText) || obs.includes(searchText);
                const matchesDate = !selectedDate || date === selectedDate;

                row.style.display = matchesSearch && matchesDate ? '' : 'none';
            });
        }

        searchInput.addEventListener('input', filterTable);
        filterDate.addEventListener('change', filterTable);
        clearFilters.addEventListener('click', () => {
            searchInput.value = '';
            filterDate.value = '';
            filterTable();
        });
    });
$(document).ready(function () {
    // Função para filtrar lembretes ao clicar nas opções do dropdown
    $(document).ready(function () {
    // Função para filtrar lembretes ao clicar nas opções do dropdown
    $('.dropdown-item').click(function (event) {
        event.preventDefault(); // Previne o comportamento padrão de navegação

        // Pega o filtro selecionado
        var filtro = $(this).attr('href').split('=')[1];
        console.log("Filtro selecionado: " + filtro); // Exibe o filtro no console

        // Verifica se o filtro foi encontrado
        if (!filtro || filtro.trim() === "") { // Verifica se o filtro é uma string vazia ou nula
            console.log("Filtro inválido ou não encontrado"); // Adicionando log para verificar no console
            return; // Se o filtro for inválido, não faz a requisição AJAX
        }

        // Faz uma requisição AJAX para obter os lembretes filtrados
        $.ajax({
            url: '/filtrar-lembretes/', // Endereço no backend para processar os filtros
            type: 'GET',
            data: { filtro_data: filtro }, // Envia o filtro selecionado
            success: function (response) {
                console.log("Resposta recebida: ", response); // Verifica o que o servidor retornou

                // Atualiza o conteúdo da tabela com os lembretes filtrados
                $('#tabela-lembretes').html(response.tabela); // Assumindo que o servidor retorna uma tabela renderizada
                $('#mensagem').text(response.mensagem); // Atualiza a mensagem de status, se aplicável
            },
            
        });
    });

    // Outros códigos para excluir e editar lembretes continuam aqui...
});


    // Excluir lembrete
    $('button[id^="excluir-lembrete-"]').click(function () {
        var lembreteId = $(this).data('lembrete-id');

        // Exibe a modal de confirmação
        $('#modalExcluir').modal('show');

        // Ao confirmar a exclusão
        $('#confirmar-exclusao').click(function () {
            // Faz a requisição AJAX para excluir o lembrete
            $.ajax({
                url: '/excluir-lembrete/' + lembreteId + '/', // URL para exclusão
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val(),
                },
                success: function (response) {
                    // Se a exclusão for bem-sucedida, remove a linha da tabela
                    $('#excluir-lembrete-' + lembreteId).closest('tr').remove();
                    $('#modalExcluir').modal('hide'); // Fecha a modal
                },
                error: function (xhr, status, error) {
                    console.log("Erro no AJAX de exclusão: ", error); // Exibe o erro no console
                    alert('Erro ao excluir o lembrete');
                }
            });
        });
    });

    // Editar lembrete
    $('button[id^="editar-lembrete-"]').click(function () {
        var lembreteId = $(this).data('lembrete-id');
        var titulo = $(this).data('lembrete-titulo');
        var obs = $(this).data('lembrete-obs');
        var data = $(this).closest('tr').find('td').eq(2).text();

        // Preenche os campos do formulário de edição com os dados do lembrete
        $('#titulo').val(titulo);
        $('#obs').val(obs);
        $('#data').val(data);
        $('#lembrete-id').val(lembreteId);

        // Exibe a modal de edição
        $('#modalEditar').modal('show');
    });

    // Enviar o formulário de edição
    $('#form-editar-lembrete').submit(function (event) {
        event.preventDefault();

        var lembreteId = $('#lembrete-id').val();
        var titulo = $('#titulo').val();
        var obs = $('#obs').val();
        var data = $('#data').val();

        $.ajax({
            url: '/editar-lembrete/' + lembreteId + '/', // URL para edição
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val(),
                'titulo': titulo,
                'obs': obs,
                'data': data
            },
            success: function (response) {
                var row = $('button[id="editar-lembrete-' + lembreteId + '"]').closest('tr');
                row.find('td').eq(0).text(titulo);
                row.find('td').eq(1).text(obs);
                row.find('td').eq(2).text(data);
                $('#modalEditar').modal('hide');
            },
            error: function (xhr, status, error) {
                console.log("Erro no AJAX de edição: ", error); // Exibe o erro no console
                alert('Erro ao editar o lembrete');
            }
        });
    });

    // Alternar o dropdown
    $('#dropdownButton').click(function () {
        var dropdownMenu = $('#dropdownMenu');
        dropdownMenu.toggle(); // Alterna a exibição do menu
    });
});


</script>

{% endblock %}
